
**Problem Statement:**

There are multiple antivirus software which are running on the system and you have the data of how many malware they have detected in each run.  
You need to find out how many malwares each software has detected in their latest run and what is the difference between the number of malwares detected in latest run and the second last run for each software. 
Please note that list only the software which have run for at least 2 times and have detected at least 10 malware in the latest run.
| software_id | latest_run_count | difference_to_previous |
|-------------|-----------------|------------------------|
|         101 |               12 |                      2 |
|         102 |               13 |                     -1 |
|         103 |               16 |                      5 |

```
WITH ranked_malwares AS (
  select 
  *,
  RANK() OVER(PARTITION BY software_id ORDER BY run_date DESC) AS rnk
  FROM malware
  ),
  CTE AS (
  SELECT 
software_id,
SUM(CASE WHEN rnk = 1 THEN malware_detected END) AS latest_run_count,
SUM(CASE WHEN rnk = 2 THEN malware_detected END) AS prev_run_count
FROM ranked_malwares
WHERE rnk IN (1, 2)
GROUP BY software_id
HAVING COUNT(*) = 2
   )
  SELECT software_id, latest_run_count, 
  (latest_run_count-prev_run_count) AS difference_to_previous
  FROM CTE
  WHERE latest_run_count >= 10
```
